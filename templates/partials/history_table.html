<!-- History Table Partial -->

<!-- Failed Files Section -->
{% if failed_files %}
<div class="mb-8">
    <h3 class="text-sm font-medium text-red-400 mb-3">‚ùå Failed Downloads ({{ failed_files|length }})</h3>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="text-left text-xs text-gray-500 border-b border-gray-800">
                    <th class="pb-2">Type</th>
                    <th class="pb-2">Name</th>
                    <th class="pb-2">Error</th>
                    <th class="pb-2">Retries</th>
                    <th class="pb-2 text-right">Action</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                {% for file in failed_files %}
                <tr id="file-row-{{ file.id }}" class="border-b border-gray-800/50">
                    <td class="py-2">
                        {% if file.file_type == 'audio' %}
                        <span class="text-purple-400">üéµ</span>
                        {% else %}
                        <span class="text-red-400">üìÑ</span>
                        {% endif %}
                    </td>
                    <td class="py-2">
                        <div class="max-w-xs truncate text-white text-sm">{{ file.file_name }}</div>
                    </td>
                    <td class="py-2">
                        <span class="text-red-400 text-xs truncate max-w-xs block" title="{{ file.error_message }}">
                            {{ file.error_message[:50] }}{% if file.error_message and file.error_message|length > 50
                            %}...{% endif %}
                        </span>
                    </td>
                    <td class="py-2 text-gray-400 text-xs">
                        {{ file.retry_count }}/3
                    </td>
                    <td class="py-2 text-right">
                        {% if file.status != 'FAILED_PERMANENT' %}
                        <button hx-post="/files/{{ file.id }}/retry" hx-target="#file-row-{{ file.id }}"
                            hx-swap="outerHTML"
                            class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs text-white">
                            Retry
                        </button>
                        {% else %}
                        <span class="text-gray-500 text-xs">Permanent</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Completed Files Section -->
<div>
    <h3 class="text-sm font-medium text-green-400 mb-3">‚úì Completed Downloads</h3>

    {% if completed_files %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="text-left text-xs text-gray-500 border-b border-gray-800">
                    <th class="pb-2">Type</th>
                    <th class="pb-2">Name</th>
                    <th class="pb-2">Category</th>
                    <th class="pb-2">Size</th>
                    <th class="pb-2">Processed</th>
                    <th class="pb-2">Date</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                {% for file in completed_files %}
                <tr class="border-b border-gray-800/50">
                    <td class="py-2">
                        {% if file.file_type == 'audio' %}
                        <span class="text-purple-400">üéµ</span>
                        {% else %}
                        <span class="text-red-400">üìÑ</span>
                        {% endif %}
                    </td>
                    <td class="py-2">
                        <div class="max-w-xs truncate text-white text-sm">{{ file.file_name }}</div>
                    </td>
                    <td class="py-2 text-gray-400 text-xs">
                        {{ file.destination_category or '--' }}
                    </td>
                    <td class="py-2 text-gray-400 text-xs">
                        {% if file.file_size %}
                        {% if file.file_size < 1048576 %} {{ (file.file_size / 1024)|round(1) }} KB {% else %} {{
                            (file.file_size / 1048576)|round(1) }} MB {% endif %} {% endif %} </td>
                    <td class="py-2">
                        {% if file.processing_status == 'PROCESSED' %}
                        <span class="text-green-400 text-xs">‚úì Processed</span>
                        {% elif file.processing_status == 'PROCESSING' %}
                        <span class="text-amber-400 text-xs animate-pulse">Processing...</span>
                        {% else %}
                        <span class="text-gray-500 text-xs">Pending</span>
                        {% endif %}
                    </td>
                    <td class="py-2 text-gray-400 text-xs">
                        {% if file.updated_at %}
                        {{ file.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex items-center justify-center gap-2 mt-6">
        {% if page > 1 %}
        <button hx-get="/history?page={{ page - 1 }}&per_page={{ per_page }}" hx-target="#history-content > div"
            hx-swap="innerHTML" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">
            ‚Üê Prev
        </button>
        {% endif %}

        <span class="px-3 py-1 text-gray-400 text-sm">
            Page {{ page }} of {{ total_pages }}
        </span>

        {% if page < total_pages %} <button hx-get="/history?page={{ page + 1 }}&per_page={{ per_page }}"
            hx-target="#history-content > div" hx-swap="innerHTML"
            class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-sm">
            Next ‚Üí
            </button>
            {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="text-center py-8">
        <div class="text-3xl mb-2">üì≠</div>
        <p class="text-gray-500 text-sm">No completed downloads yet</p>
    </div>
    {% endif %}
</div>