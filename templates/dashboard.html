<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleMinion V2 - Dashboard</title>
    <meta name="description" content="Telegram to MinIO file automation dashboard">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#1e1e2e',
                            200: '#181825',
                            300: '#11111b'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(30, 30, 46, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(99, 102, 241, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
            }
        }

        .gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tab-active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        /* Modal styles */
        dialog {
            background: transparent;
            border: none;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Sortable header styles */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            color: #6366f1;
        }

        .htmx-request {
            opacity: 0.7;
        }
    </style>
</head>

<body class="text-gray-200">
    <!-- Header -->
    <header class="glass border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                    style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold gradient-text">TeleMinion V2</h1>
                    <p class="text-xs text-gray-500">Telegram ‚Üí MinIO Pipeline</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- Connection Status -->
                <div class="flex items-center gap-2 text-sm">
                    <span
                        class="w-2 h-2 rounded-full {% if telegram_connected %}bg-green-500{% else %}bg-red-500{% endif %}"></span>
                    <span class="text-gray-400">Telegram: {% if telegram_connected %}Connected{% else %}Disconnected{%
                        endif %}</span>
                </div>

                {% if auth_enabled %}
                <a href="/logout" class="text-sm text-gray-400 hover:text-white transition-colors">
                    Logout
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Telegram Auth Section (if not connected) -->
        {% if not telegram_connected %}
        <div class="glass rounded-xl p-6 mb-8">
            <h2 class="text-lg font-semibold text-white mb-4">üîê Telegram Authentication Required</h2>
            <div id="auth-container">
                <button hx-post="/auth/send-code" hx-target="#auth-container" hx-swap="innerHTML"
                    class="px-6 py-2 rounded-lg font-medium text-white transition-all hover:opacity-90"
                    style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    Send Verification Code
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Stats Cards -->
        <div id="stats-container" hx-get="/stats" hx-trigger="load, every 30s" hx-swap="innerHTML">
            {% include 'partials/stats_cards.html' %}
        </div>

        <!-- Tabs -->
        <div class="glass rounded-xl mt-8 overflow-hidden">
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-800">
                <button onclick="switchTab('pending')" id="tab-pending"
                    class="tab-btn px-6 py-3 text-sm font-medium transition-colors tab-active text-white rounded-t-lg">
                    üì• Pending
                </button>
                <button onclick="switchTab('active')" id="tab-active"
                    class="tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    ‚ö° Active
                </button>
                <button onclick="switchTab('history')" id="tab-history"
                    class="tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    üìú History
                </button>
                <button onclick="switchTab('channels')" id="tab-channels"
                    class="tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                    üì° Channels
                </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Pending Tab -->
                <div id="pending-content" class="tab-content">
                    <div hx-get="/pending?page=1&per_page=50" hx-trigger="load, refresh from:body" hx-swap="innerHTML">
                        <div class="animate-pulse text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Active Tab -->
                <div id="active-content" class="tab-content hidden">
                    <div hx-get="/active" hx-trigger="load, every 5s" hx-swap="innerHTML">
                        <div class="animate-pulse text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history-content" class="tab-content hidden">
                    <div hx-get="/history?page=1" hx-trigger="load" hx-swap="innerHTML">
                        <div class="animate-pulse text-gray-500">Loading...</div>
                    </div>
                </div>

                <!-- Channels Tab -->
                <div id="channels-content" class="tab-content hidden">
                    <!-- Add Channel Form -->
                    <div class="mb-6">
                        <form hx-post="/channels/add" hx-target="#channels-list" hx-swap="innerHTML" class="flex gap-3">
                            <input type="text" name="channel_input" placeholder="Channel username, link, or ID" class="flex-1 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg 
                                          focus:outline-none focus:border-indigo-500 text-white">
                            <button type="submit" class="px-6 py-2 rounded-lg font-medium text-white"
                                style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                                Add Channel
                            </button>
                        </form>
                    </div>
                    <div id="channels-list" hx-get="/channels" hx-trigger="load" hx-swap="innerHTML">
                        <div class="animate-pulse text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Batch Modal -->
    <dialog id="batch-modal" class="rounded-xl w-full max-w-lg">
        <div class="glass rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Approve Selected Files</h3>
                <button onclick="document.getElementById('batch-modal').close()" class="text-gray-400 hover:text-white">
                    ‚úï
                </button>
            </div>
            <div id="batch-modal-content">
                <!-- Content loaded via HTMX -->
            </div>
        </div>
    </dialog>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active', 'text-white');
                el.classList.add('text-gray-400');
            });

            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');

            // Add active class to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.add('tab-active', 'text-white');
            activeTab.classList.remove('text-gray-400');
        }

        // Batch selection handling
        let selectedFiles = new Set();

        function toggleFileSelection(checkbox, fileId) {
            if (checkbox.checked) {
                selectedFiles.add(fileId);
            } else {
                selectedFiles.delete(fileId);
            }
            updateBatchActionBar();
        }

        function toggleAllFiles(checkbox) {
            document.querySelectorAll('.file-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
                const fileId = parseInt(cb.dataset.fileId);
                if (checkbox.checked) {
                    selectedFiles.add(fileId);
                } else {
                    selectedFiles.delete(fileId);
                }
            });
            updateBatchActionBar();
        }

        function updateBatchActionBar() {
            const bar = document.getElementById('batch-action-bar');
            const count = document.getElementById('selected-count');

            if (bar && count) {
                if (selectedFiles.size > 0) {
                    bar.classList.remove('hidden');
                    count.textContent = selectedFiles.size;
                } else {
                    bar.classList.add('hidden');
                }
            }
        }

        function openBatchModal() {
            if (selectedFiles.size === 0) return;

            // Build form data
            const formData = new FormData();
            selectedFiles.forEach(id => {
                formData.append('file_ids[]', id);
            });

            // Fetch modal content
            fetch('/files/batch/preview', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(html => {
                    const modalContent = document.getElementById('batch-modal-content');
                    modalContent.innerHTML = html;
                    // Process HTMX attributes on the newly added content
                    htmx.process(modalContent);
                    document.getElementById('batch-modal').showModal();
                });
        }

        // Clear selection after batch action
        document.body.addEventListener('htmx:afterRequest', function (event) {
            if (event.detail.pathInfo.requestPath === '/files/batch/approve') {
                selectedFiles.clear();
                updateBatchActionBar();
            }
        });
    </script>
</body>

</html>